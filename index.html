<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿å¼·å…¨å°å‹•æ…‹æ°£è±¡ç«™</title> 
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link rel="apple-touch-icon" href="./icon-v2.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-v2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* æ ¸å¿ƒï¼šå‹•æ…‹ CSS è®Šæ•¸ */
        :root {
            --ac-green: #7DE1A9; /* ä¸»èƒŒæ™¯ */
            --ac-bg-pattern: #8FD8AF; /* èƒŒæ™¯æ–œç´‹ï¼ˆAccent è‰²ï¼Œè¼ƒæ·±ï¼‰*/
            --ac-cream: #FFFEF2; /* å¡ç‰‡èƒŒæ™¯ */
            --ac-yellow: #F9F195; /* åœ°é»æ¨™ç±¤/å¼·èª¿è‰² */
            --ac-brown: #796452; /* ä¸»è¦æ–‡å­—è‰² */
            --ac-blue: #4FB5D9; /* **ã€é‡è¦ã€‘è¼ƒæ·±çš„æ™‚æ®µæ°£æ³¡è‰² (Accent)** */
            --ac-dark: #58504A; /* ç´°ç¯€æ–‡å­—è‰² */
            --ac-card-border: #E6E0C8;
        }

        /* --- ICON å‹•ç•«é—œéµå¹€ (ä¿æŒä¸è®Š) --- */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes sun-happy {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-8px) rotate(5deg) scale(1.02); }
            50% { transform: translateY(0) rotate(0deg) scale(1); }
            75% { transform: translateY(-4px) rotate(-3deg) scale(1.01); }
            100% { transform: translateY(0) rotate(0deg) scale(1); }
        }
        @keyframes cloud-float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-7px) scale(1.03); }
        }
        @keyframes rain-shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-3px, -3px); }
            50% { transform: translate(3px, 0); }
            75% { transform: translate(-1px, 3px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes thunder-pulse {
            0% { transform: translate(0, 0) scale(1); filter: brightness(1); }
            50% { transform: translate(4px, 0) scale(1.05); filter: brightness(1.2); }
            100% { transform: translate(-4px, 0) scale(1); filter: brightness(1); }
        }
        @keyframes snow-drift {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(8px) rotate(10deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes loader-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        /* --- /ICON å‹•ç•«é—œéµå¹€ --- */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Klee One', 'Noto Sans TC', sans-serif; 
            background-color: var(--ac-green);
            background-image: none; /* JS å°‡æœƒè¨­å®šæ–°çš„å–®å±¤æ¼¸å±¤ */
            min-height: 100vh;
            color: var(--ac-dark);
            overflow-x: hidden;
            padding-bottom: 20px;
            transition: background-color 0.5s ease, background-image 0.5s ease; /* è®“æ¼¸å±¤åˆ‡æ›æ›´å¹³æ»‘ */
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* åŒ…è£¹åŸå¸‚é¸æ“‡å™¨ï¼Œç”¨æ–¼å®šä½ç®­é ­ */
        .city-select-wrapper {
            position: relative; 
            display: inline-block; 
        }

        /* åŸå¸‚é¸æ“‡å™¨ï¼šæ·±è‰²èƒŒæ™¯å’Œç™½è‰²æ–‡å­— */
        .city-select {
            background: var(--ac-blue);
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px;
            font-weight: 400; /* å–æ¶ˆç²—é«” */
            font-size: 1.1rem;
            border: 2px solid white;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
            text-align: center;
            padding-right: 30px; /* ä»ç„¶ç‚ºç®­é ­é ç•™ç©ºé–“ */
            transition: background 0.3s, color 0.3s;
        }
        
        /* ä¸‹æ‹‰ç®­é ­æ¨£å¼ */
        .city-select-wrapper::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 12px; 
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent; /* ã€ä¿®æ­£ã€‘å°ºå¯¸ç¸®å°å› 8px */
            border-right: 8px solid transparent; /* ã€ä¿®æ­£ã€‘å°ºå¯¸ç¸®å°å› 8px */
            border-top: 8px solid #FFFFFF; /* ã€ä¿®æ­£ã€‘ä½¿ç”¨ç´”ç™½è‰² */
            filter: none; /* ã€ä¿®æ­£ã€‘ç§»é™¤å…‰æšˆï¼Œç¢ºä¿æ¸…æ™°åº¦ */
            pointer-events: none; 
            transition: transform 0.3s ease;
        }

        .city-select option {
            background: white; 
            color: var(--ac-dark);
        }

        /* å³å´æ—¥æœŸï¼šåŠ ç²—ã€åœ“è§’å’Œå¤–æ¡† */
        .update-pill {
            font-size: 0.8rem;
            color: white;
            background: var(--ac-blue);
            padding: 5px 15px; 
            border-radius: 20px; 
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            border: 2px solid white; 
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1); 
            transition: background 0.3s;
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* === æ ¸å¿ƒï¼šä»Šæ—¥ç„¦é»å¡ç‰‡ === */
        .hero-card {
            background: var(--ac-cream);
            border-radius: 35px;
            padding: 30px 25px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 4px solid white;
            margin-bottom: 25px;
            position: relative;
            transition: background 0.5s, box-shadow 0.5s;
        }

        .hero-period {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ac-blue);
            color: white;
            padding: 5px 20px;
            border-radius: 20px;
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            border: 3px solid white;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.3s;
        }

        .hero-temp-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        /* ICON æ¨£å¼èˆ‡å‹•ç•« */
        .hero-icon {
            font-size: 5rem;
            filter: drop-shadow(0 4px 0 rgba(0, 0, 0, 0.1));
            transition: transform 0.3s;
        }
        
        .hero-temp {
            font-size: 4.5rem;
            font-weight: 900; /* ä¿ç•™æ¥µç²—é«”è®“æº«åº¦æ•¸å­—æœ‰ä»½é‡ */
            color: var(--ac-brown);
            line-height: 1;
            transition: color 0.3s;
        }

        .hero-desc {
            font-size: 1.5rem;
            font-weight: 600; 
            color: var(--ac-dark);
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        /* === å¿«é€Ÿå»ºè­°å€ === */
        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #E0D8C0;
        }

        .advice-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 20px;
        }

        .advice-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .advice-text {
            font-size: 1.4rem;
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            color: var(--ac-brown);
            margin: 5px 0;
            line-height: 1.2;
            transition: color 0.3s;
        }

        /* === ç¨å¾Œé å ±ï¼šæ©«å‘æ»‘å‹•å€ === */
        .section-title {
            /* ã€æ–°å¢å¤–æ¡†ã€‘ */
            font-size: 1.2rem;
            color: white;
            background: var(--ac-blue);
            padding: 5px 15px; 
            border-radius: 20px; 
            border: 2px solid white; /* ç™½è‰²å¤–æ¡† */
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1); /* é™°å½± */
            margin-bottom: 15px;
            margin-left: 10px;
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
            display: inline-block; 
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .mini-card {
            min-width: 140px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 25px;
            padding: 20px 15px;
            text-align: center;
            border: 3px solid white;
            flex-shrink: 0;
            transition: background 0.3s;
        }

        .mini-time {
            /* ã€æ–°å¢å¤–æ¡†ã€‘ */
            background: var(--ac-blue); 
            color: white;
            padding: 5px 10px; 
            border-radius: 20px; /* çµ±ä¸€åœ“è§’ */
            font-size: 0.8rem;
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            border: 2px solid white; /* ç™½è‰²å¤–æ¡† */
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1); /* è¼•å¾®é™°å½± */
            display: inline-block;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .mini-icon {
            font-size: 2.5rem;
            margin: 5px 0;
        }

        .mini-temp {
            font-size: 1.2rem;
            font-weight: 600; /* å–æ¶ˆç²—é«” */
            color: var(--ac-dark);
        }

        /* Loading ç•«é¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--ac-green);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: background-color 0.5s ease;
        }
        
        /* ç´” CSS ç¾ä»£è¼‰å…¥å™¨æ¨£å¼ */
        .weather-loader {
            width: 60px;
            height: 60px;
            position: relative;
            animation: spin 1.5s linear infinite; /* è®“æ•´é«”æ—‹è½‰ï¼Œé€Ÿåº¦æ›´å¹³ç©© */
            transform-origin: center;
        }
        
        .weather-loader::before, .weather-loader::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            transition: all 0.3s;
        }

        /* å…§ç’°ï¼šè¿½é€æ•ˆæœ */
        .weather-loader::before {
            width: 100%;
            height: 100%;
            border: 7px solid rgba(255, 255, 255, 0.4); /* åŠé€æ˜çš„åº•è‰² */
            border-top-color: var(--ac-blue); /* ä¸»é¡Œè‰²çš„è¿½é€éƒ¨åˆ† */
            animation: loader-pulse 0.7s ease-in-out infinite alternate;
        }

        /* å¤–ç’°ï¼šå…‰æšˆé»ç¶´ */
        .weather-loader::after {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border: 4px solid var(--ac-blue);
            border-top-color: white; 
            border-left-color: white;
            animation: spin 3s linear infinite reverse; /* åå‘æ—‹è½‰ï¼Œå¢åŠ å±¤æ¬¡æ„Ÿ */
        }
        
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="weather-loader"></div>
        <p style="color: white; font-weight: 400; margin-top: 20px; padding: 8px 15px; border-radius: 8px; background: var(--ac-blue); border: 2px solid white;">æ­£åœ¨éƒ¨ç½²å¤©æ°£èª¿è‰²ç›¤...</p>
    </div>
    <div class="status-bar">
        <div class="city-select-wrapper">
            <select id="citySelector" class="city-select">
                <option value="taipei">è‡ºåŒ—å¸‚</option>
                <option value="newtaipei">æ–°åŒ—å¸‚</option>
                <option value="taoyuan">æ¡ƒåœ’å¸‚</option>
                <option value="taichung">è‡ºä¸­å¸‚</option>
                <option value="tainan">è‡ºå—å¸‚</option>
                <option value="kaohsiung" selected>é«˜é›„å¸‚</option>
                <option value="keelung">åŸºéš†å¸‚</option>
                <option value="hsinchu">æ–°ç«¹å¸‚</option>
                <option value="hsinchucounty">æ–°ç«¹ç¸£</option>
                <option value="miaoli">è‹—æ —ç¸£</option>
                <option value="changhua">å½°åŒ–ç¸£</option>
                <option value="nantou">å—æŠ•ç¸£</option>
                <option value="yunlin">é›²æ—ç¸£</option>
                <option value="chiayi">å˜‰ç¾©å¸‚</option>
                <option value="chiayicounty">å˜‰ç¾©ç¸£</option>
                <option value="pingtung">å±æ±ç¸£</option>
                <option value="yilan">å®œè˜­ç¸£</option>
                <option value="hualien">èŠ±è“®ç¸£</option>
                <option value="taitung">è‡ºæ±ç¸£</option>
                <option value="penghu">æ¾æ¹–ç¸£</option>
                <option value="kinmen">é‡‘é–€ç¸£</option>
                <option value="lianjiang">é€£æ±Ÿç¸£</option>
            </select>
        </div>
        <div id="updateTime" class="update-pill">æ›´æ–°ä¸­...</div>
    </div>

    <div class="container" id="mainContent" style="display: none;">

        <div id="heroCard">
        </div>

        <h3 class="section-title">ç¨å¾Œé å ±</h3>
        <div class="scroll-container" id="futureForecasts">
        </div>

    </div>

    <script>
        const BASE_API_URL = "https://archang-weather.zeabur.app/api/weather/";
        
        // å°ç£ç¸£å¸‚ Slug èˆ‡ä¸­æ–‡åç¨±æ˜ å°„
        const CITIES = {
            taipei: 'è‡ºåŒ—å¸‚', newtaipei: 'æ–°åŒ—å¸‚', taoyuan: 'æ¡ƒåœ’å¸‚', taichung: 'è‡ºä¸­å¸‚', tainan: 'è‡ºå—å¸‚', kaohsiung: 'é«˜é›„å¸‚',
            keelung: 'åŸºéš†å¸‚', hsinchu: 'æ–°ç«¹å¸‚', hsinchucounty: 'æ–°ç«¹ç¸£', miaoli: 'è‹—æ —ç¸£', changhua: 'å½°åŒ–ç¸£', nantou: 'å—æŠ•ç¸£',
            yunlin: 'é›²æ—ç¸£', chiayi: 'å˜‰ç¾©å¸‚', chiayicounty: 'å˜‰ç¾©ç¸£', pingtung: 'å±æ±ç¸£', yilan: 'å®œè˜­ç¸£', hualien: 'èŠ±è“®ç¸£',
            taitung: 'è‡ºæ±ç¸£', penghu: 'æ¾æ¹–ç¸£', kinmen: 'é‡‘é–€ç¸£', lianjiang: 'é€£æ±Ÿç¸£'
        };

        // å°ç£ä¸»è¦åŸå¸‚ä¸­å¿ƒé»ç¶“ç·¯åº¦ (ç”¨æ–¼ Geolocation åˆ¤æ–·) - åƒ…åˆ—å‡ºå…­éƒ½
        const CITY_COORDINATES = [
            { lat: 25.0330, lon: 121.5654, slug: 'taipei' }, // è‡ºåŒ—å¸‚ (ä¸­æ­£å€)
            { lat: 24.9961, lon: 121.4630, slug: 'newtaipei' }, // æ–°åŒ—å¸‚ (æ¿æ©‹å€)
            { lat: 25.0489, lon: 121.3005, slug: 'taoyuan' }, // æ¡ƒåœ’å¸‚ (æ¡ƒåœ’å€)
            { lat: 24.1375, lon: 120.6881, slug: 'taichung' }, // è‡ºä¸­å¸‚ (ä¸­å€)
            { lat: 22.9909, lon: 120.2131, slug: 'tainan' }, // è‡ºå—å¸‚ (ä¸­è¥¿å€)
            { lat: 22.6272, lon: 120.3014, slug: 'kaohsiung' }, // é«˜é›„å¸‚ (è‹“é›…å€)
        ];


        // æ­¥é©Ÿä¸€ï¼šå®šç¾©å‹•æ…‹é¡è‰²ä¸»é¡Œ (å·²äº¤æ›è‡ºåŒ—å¸‚å’Œæ¡ƒåœ’å¸‚)
        const COLOR_PALETTES = {
            // è‡ºåŒ—å¸‚ (ç¶ è‰²ç³» - åŸæ¡ƒåœ’å¸‚é…è‰²)
            taipei: { bg: '#C9E4B3', accent: '#6B8E23', card: '#F8FFF0', pill: '#9BC26A', text: '#4B6615', brown: '#404040', dark: '#707070' },
            // æ¡ƒåœ’å¸‚ (è—è‰²ç³» - åŸè‡ºåŒ—å¸‚é…è‰²)
            taoyuan: { bg: '#A0D1FF', accent: '#3A80D8', card: '#F0F4F8', pill: '#5C90D2', text: '#1E4E80', brown: '#333333', dark: '#666666' },
            
            // å…¶é¤˜åŸå¸‚ä¿æŒä¸è®Š
            newtaipei: { bg: '#E4B3B3', accent: '#D83A3A', card: '#FFF0F0', pill: '#C25C5C', text: '#801E1E', brown: '#333333', dark: '#666666' },
            taichung: { bg: '#E4B3D8', accent: '#803A9D', card: '#FFF8FA', pill: '#B26AA8', text: '#5D1E70', brown: '#333333', dark: '#666666' },
            tainan: { bg: '#FFD1A0', accent: '#FF7F50', card: '#FFF8F0', pill: '#FF9966', text: '#A85E3A', brown: '#504030', dark: '#807060' },
            kaohsiung: { bg: '#F0E4B3', accent: '#D8A03A', card: '#FFFFF8', pill: '#C29B6A', text: '#805C1E', brown: '#504030', dark: '#807060' },
            keelung: { bg: '#CCCCE6', accent: '#5C5C96', card: '#F0F0FF', pill: '#8A8AD0', text: '#3E3E66', brown: '#333333', dark: '#666666' },
            hsinchu: { bg: '#B3E4E4', accent: '#3A9D9D', card: '#F0FFFF', pill: '#6AB2B2', text: '#1E5D5D', brown: '#333333', dark: '#666666' },
            hsinchucounty: { bg: '#B3E4CC', accent: '#3A9D6A', card: '#F0FFFA', pill: '#6AB29B', text: '#1E5D3E', brown: '#333333', dark: '#666666' },
            miaoli: { bg: '#D8B3E4', accent: '#9D3A9D', card: '#FFF0FF', pill: '#B26AB2', text: '#5D1E5D', brown: '#333333', dark: '#666666' },
            changhua: { bg: '#E4CCB3', accent: '#9D6A3A', card: '#FFFBF0', pill: '#B29B6A', text: '#5D3E1E', brown: '#504030', dark: '#807060' },
            nantou: { bg: '#D8D8B3', accent: '#9D9D3A', card: '#FFFFF0', pill: '#B2B26A', text: '#5D5D1E', brown: '#504030', dark: '#807060' },
            yunlin: { bg: '#E6E6B3', accent: '#A0A03A', card: '#FFFFF0', pill: '#C2C26A', text: '#606020', brown: '#504030', dark: '#807060' },
            chiayi: { bg: '#FFB3CC', accent: '#D83A80', card: '#FFF0F5', pill: '#C26A9B', text: '#801E4E', brown: '#333333', dark: '#666666' },
            chiayicounty: { bg: '#FFCCCC', accent: '#E04A70', card: '#FFF5F8', pill: '#C27A90', text: '#802D43', brown: '#333333', dark: '#666666' },
            pingtung: { bg: '#FFB380', accent: '#D85C3A', card: '#FFF8F0', pill: '#C27C5C', text: '#803E1E', brown: '#504030', dark: '#807060' },
            yilan: { bg: '#B3B3FF', accent: '#5C5CFF', card: '#F0F0FF', pill: '#8A8AFF', text: '#3E3E99', brown: '#333333', dark: '#666666' },
            hualien: { bg: '#B3E4FF', accent: '#3A9DD8', card: '#F0FFFF', pill: '#6AB2C2', text: '#1E5D80', brown: '#333333', dark: '#666666' },
            taitung: { bg: '#FFD8A0', accent: '#D88E3A', card: '#FFF8F0', pill: '#C29B6A', text: '#805C1E', brown: '#504030', dark: '#807060' },
            penghu: { bg: '#E0FFFF', accent: '#4A90A0', card: '#FFFFFF', pill: '#7CACC2', text: '#2D5866', brown: '#333333', dark: '#666666' },
            kinmen: { bg: '#B3B3A0', accent: '#70705C', card: '#F0F0E0', pill: '#9B9B8A', text: '#4A4A3E', brown: '#504030', dark: '#807060' },
            lianjiang: { bg: '#E4E4E4', accent: '#A0A0A0', card: '#FFFFFF', pill: '#C2C2C2', text: '#606060', brown: '#333333', dark: '#666666' },
        };
        
        let currentCitySlug = "kaohsiung";
        
        function applyTheme(citySlug) {
            const palette = COLOR_PALETTES[citySlug] || COLOR_PALETTES.kaohsiung;

            const root = document.documentElement;
            root.style.setProperty('--ac-green', palette.bg);
            root.style.setProperty('--ac-bg-pattern', palette.accent);
            root.style.setProperty('--ac-cream', palette.card);
            root.style.setProperty('--ac-yellow', palette.pill); 
            root.style.setProperty('--ac-blue', palette.accent); 
            root.style.setProperty('--ac-brown', palette.brown); 
            root.style.setProperty('--ac-dark', palette.dark); 
            
            document.getElementById('loading').style.backgroundColor = palette.bg;

            // å‹•æ…‹ç”Ÿæˆä¸¦æ‡‰ç”¨æ¼¸å±¤èƒŒæ™¯ (ä¸Šæ·±ä¸‹æ·º)
            const gradient = `linear-gradient(to bottom, ${palette.accent}, ${palette.bg})`;
            
            // åƒ…æ‡‰ç”¨æ¼¸å±¤ï¼Œä¸ç–ŠåŠ ç´‹ç†
            document.body.style.backgroundImage = gradient; 
            document.body.style.backgroundColor = palette.bg; 
        }

        // èµ«å¼—è³½æ©å…¬å¼ (Haversine formula) ç°¡åŒ–ç‰ˆï¼Œè¨ˆç®—å…©é»é–“è·é›¢ (å…¬é‡Œ)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // è·é›¢ (å…¬é‡Œ)
        }

        // æ ¹æ“šç¶“ç·¯åº¦å°‹æ‰¾æœ€è¿‘çš„åŸå¸‚ä»£ç¢¼
        function findNearestCity(userLat, userLon) {
            let nearestCity = 'kaohsiung'; // é è¨­å€¼
            let minDistance = Infinity;

            CITY_COORDINATES.forEach(city => {
                const distance = getDistance(userLat, userLon, city.lat, city.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestCity = city.slug;
                }
            });
            return nearestCity;
        }


        // åŠŸèƒ½ 3: å¯æ„›åœ–ç¤ºèˆ‡å¾®å‹•ç•« (å¢å¼·ç‰ˆ)
        function getWeatherIcon(weather) {
            let icon = "ğŸŒ¤ï¸";
            let animation = "bounce 3s infinite";
            
            if (!weather) return { icon: "â“", animation: "bounce 2s infinite" };

            if (weather.includes("æ™´")) {
                icon = "â˜€ï¸";
                animation = "sun-happy 2s ease-in-out infinite";
            } else if (weather.includes("å¤šé›²")) {
                icon = "â›…";
                animation = "cloud-float 3s ease-in-out infinite";
            } else if (weather.includes("é™°")) {
                icon = "â˜ï¸";
                animation = "cloud-float 4s ease-in-out infinite";
            } else if (weather.includes("é›¨")) {
                icon = "ğŸŒ§ï¸";
                animation = "rain-shake 0.8s linear infinite";
            } else if (weather.includes("é›·")) {
                icon = "â›ˆï¸";
                animation = "thunder-pulse 0.4s linear infinite";
            } else if (weather.includes("é›ª")) {
                icon = "â„ï¸";
                animation = "snow-drift 4s linear infinite alternate";
            }

            return { icon, animation };
        }

        function getAdvice(rainProb, maxTemp) {
            let rainIcon = "ğŸŒ‚";
            let rainText = "ä¸ç”¨å¸¶å‚˜";
            if (parseInt(rainProb) > 30) {
                rainIcon = "â˜”";
                rainText = "è¨˜å¾—å¸¶å‚˜ï¼";
            }

            let clothIcon = "ğŸ‘•";
            let clothText = "èˆ’é©ç©¿æ­";
            if (parseInt(maxTemp) >= 28) {
                clothIcon = "ğŸ½";
                clothText = "çŸ­è¢–å‡ºç™¼";
            } else if (parseInt(maxTemp) <= 20) {
                clothIcon = "ğŸ§¥";
                clothText = "åŠ ä»¶å¤–å¥—";
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "æ—©æ™¨";
            if (hour >= 11 && hour < 14) return "ä¸­åˆ";
            if (hour >= 14 && hour < 18) return "ä¸‹åˆ";
            if (hour >= 18 && hour < 23) return "æ™šä¸Š";
            return "æ·±å¤œ";
        }

        function renderWeather(data) {
            const forecasts = data.forecasts;
            const current = forecasts[0];
            const others = forecasts.slice(1);

            // 1. æ¸²æŸ“ Hero Card (ä¸»ç•«é¢)
            const advice = getAdvice(current.rain, current.maxTemp);
            const period = getTimePeriod(current.startTime);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);
            
            const currentIcon = getWeatherIcon(current.weather);

            document.getElementById('heroCard').innerHTML = `
                        <div class="hero-card">
                            <div class="hero-period">${period}</div>
                            <div class="hero-temp-container">
                                <div class="hero-icon" style="animation: ${currentIcon.animation};">${currentIcon.icon}</div>
                                <div class="hero-temp">${avgTemp}Â°</div>
                            </div>
                            <div class="hero-desc">${current.weather}</div>
                            
                            <div class="advice-grid">
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.rainIcon}</div>
                                    <div class="advice-text">${advice.rainText}</div>
                                    <div style="font-size:0.7rem; color:var(--ac-dark)">é™é›¨ç‡ ${current.rain}</div>
                                </div>
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.clothIcon}</div>
                                    <div class="advice-text">${advice.clothText}</div>
                                    <div style="font-size:0.7rem; color:var(--ac-dark)">æœ€é«˜æº« ${current.maxTemp}Â°</div>
                                </div>
                            </div>
                        </div>
                    `;

            // 2. æ¸²æŸ“ç¨å¾Œé å ± (åŒ…å«æ˜å¤©åˆ¤æ–·)
            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';

            const todayDate = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime);

                const fDate = new Date(f.startTime);
                if (fDate.getDate() !== todayDate) {
                    p = "æ˜å¤©" + p;
                }
                
                const miniIcon = getWeatherIcon(f.weather);

                scrollContainer.innerHTML += `
                                <div class="mini-card">
                                    <div class="mini-time">${p}</div>
                                    <div class="mini-icon" style="animation: ${miniIcon.animation};">${miniIcon.icon}</div>
                                    <div class="mini-temp">${f.minTemp}Â° - ${f.maxTemp}Â°</div>
                                    <div style="font-size:0.8rem; color:#888; margin-top:5px;">ğŸ’§${f.rain}</div>
                                </div>
                            `;
            });

            // 3. å³ä¸Šè§’é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
            const now = new Date();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayIndex = now.getDay();
            const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

            document.getElementById('updateTime').textContent = `${month}æœˆ${date}æ—¥ ${days[dayIndex]}`;
            
            // éš±è— Loadingï¼Œé¡¯ç¤ºä¸»ç•«é¢
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        async function fetchWeather() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';

            // æ¯æ¬¡æŠ“å–è³‡æ–™å‰ï¼Œå…ˆæ‡‰ç”¨ä¸»é¡Œ
            applyTheme(currentCitySlug);

            const API_URL = BASE_API_URL + currentCitySlug;
            
            try {
                const delayPromise = new Promise(resolve => setTimeout(resolve, 1500));
                const fetchPromise = fetch(API_URL).then(res => res.json());

                const [_, json] = await Promise.all([delayPromise, fetchPromise]);

                if (json.success) {
                    renderWeather(json.data);
                } else {
                    throw new Error("API Error");
                }
            } catch (e) {
                console.error(e);
                alert(`[${CITIES[currentCitySlug]}] å¤©æ°£è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨çš„å¾Œç«¯ API æ˜¯å¦å·²æ”¯æ´æ­¤åŸå¸‚ (${currentCitySlug})`);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // æ­¥é©ŸäºŒï¼š Geolocation å•Ÿå‹•åŠäº‹ä»¶ç›£è½è¨­ç½®
        function setupEventListeners() {
            const citySelector = document.getElementById('citySelector');
            
            // ç›£è½åŸå¸‚è®Šæ›´äº‹ä»¶
            citySelector.addEventListener('change', (event) => {
                currentCitySlug = event.target.value; 
                fetchWeather(); // é‡æ–°æŠ“å–æ–°åŸå¸‚è³‡æ–™
            });
            
            // å˜—è©¦å–å¾—åœ°ç†ä½ç½®
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        
                        // æ‰¾åˆ°æœ€è¿‘çš„åŸå¸‚ Slug
                        const nearestCity = findNearestCity(userLat, userLon);
                        
                        // è¨­å®šä¸‹æ‹‰é¸å–®ä¸¦è§¸ç™¼è¼‰å…¥
                        currentCitySlug = nearestCity;
                        citySelector.value = nearestCity;
                        fetchWeather();
                    },
                    (error) => {
                        console.warn('Geolocation Error:', error);
                        // å¦‚æœå®šä½å¤±æ•—ï¼Œå‰‡ä½¿ç”¨ URL åƒæ•¸æˆ–é è¨­å€¼
                        handleInitialCityFallback();
                        fetchWeather();
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                // ç€è¦½å™¨ä¸æ”¯æ´ Geolocation
                console.warn('Geolocation not supported by browser.');
                handleInitialCityFallback();
                fetchWeather();
            }
        }
        
        // Geolocation å¤±æ•—æ™‚çš„å¾Œå‚™é‚è¼¯
        function handleInitialCityFallback() {
            const citySelector = document.getElementById('citySelector');
            const urlParams = new URLSearchParams(window.location.search);
            const initialCity = urlParams.get('city') || urlParams.get('currentCity') || 'kaohsiung';
            
            if (CITIES.hasOwnProperty(initialCity)) {
                currentCitySlug = initialCity;
                citySelector.value = initialCity;
            } else {
                currentCitySlug = 'kaohsiung';
                citySelector.value = 'kaohsiung';
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // DOM è¼‰å…¥å®Œæˆå¾Œï¼Œå•Ÿå‹•äº‹ä»¶ç›£è½å’Œå®šä½å˜—è©¦
            setupEventListeners();
            // æ³¨æ„ï¼šfetchWeather æœƒåœ¨ Geolocation æˆåŠŸæˆ–å¤±æ•—çš„å›èª¿ä¸­è¢«å‘¼å«ï¼Œç¢ºä¿ä¸æœƒé‡è¤‡è¼‰å…¥ã€‚
        });
    </script>
</body>

</html>